{% extends "base.html" %}
{% block title %}Google Workspace Users{% endblock %}
{% block content %}
<div class="container mt-4">
    <h1 class="text-center mb-4">Google Workspace Users</h1>

    <!-- Toolbar for bulk actions -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <button class="btn btn-danger btn-sm me-2" onclick="bulkDelete()">Delete Selected</button>
            <button class="btn btn-warning btn-sm me-2" onclick="bulkSuspend()">Suspend Selected</button>
            <button class="btn btn-primary btn-sm me-2" onclick="bulkResetPassword()">Reset Passwords</button>
        </div>
        <input type="text" class="form-control w-25" id="searchInput" placeholder="Search users..." onkeyup="filterTable()">
    </div>

    <div class="table-responsive">
        <table class="table table-hover align-middle" id="userTable">
            <thead class="table-dark">
                <tr>
                    <th style="width: 5%;"><input type="checkbox" id="select-all" /></th>
                    <th>Email</th>
                    <th>Full Name</th>
                    <th>Recovery Email</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td><input type="checkbox" class="user-checkbox" data-email="{{ user['primaryEmail'] }}"></td>
                    <td>{{ user['primaryEmail'] }}</td>
                    <td>{{ user['name']['fullName'] }}</td>
                    <td>{{ user.get('recoveryEmail', 'N/A') }}</td>
                    <td>
                        {% if user['isAdmin'] %}
                        <span class="badge bg-success">Admin</span>
                        {% else %}
                        <span class="badge bg-secondary">User</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="dropdown">
                            <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                Actions
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="resetPassword('{{ user['primaryEmail'] }}')">Reset Password</a></li>
                                <li><a class="dropdown-item" href="#" onclick="renameUser('{{ user['primaryEmail'] }}')">Rename User</a></li>
                                <li><a class="dropdown-item" href="#" onclick="addToGroup('{{ user['primaryEmail'] }}')">Add to Groups</a></li>
                                <li><a class="dropdown-item" href="#" onclick="emailUser('{{ user['primaryEmail'] }}')">Email User</a></li>
                                <li><a class="dropdown-item" href="#" onclick="suspendUser('{{ user['primaryEmail'] }}')">Suspend User</a></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="deleteUser('{{ user['primaryEmail'] }}')">Delete User</a></li>
                            </ul>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    // Select all functionality
    document.getElementById("select-all").addEventListener("click", function () {
        const checkboxes = document.querySelectorAll(".user-checkbox");
        checkboxes.forEach(checkbox => checkbox.checked = this.checked);
    });

    // Filter table rows based on search input
    function filterTable() {
        const input = document.getElementById("searchInput");
        const filter = input.value.toLowerCase();
        const rows = document.querySelectorAll("#userTable tbody tr");

        rows.forEach(row => {
            const email = row.cells[1].textContent.toLowerCase();
            const fullName = row.cells[2].textContent.toLowerCase();
            const recoveryEmail = row.cells[3].textContent.toLowerCase();

            if (email.includes(filter) || fullName.includes(filter) || recoveryEmail.includes(filter)) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        });
    }

    // Bulk actions
    async function bulkDelete() {
        const selectedEmails = getSelectedEmails();
        if (selectedEmails.length === 0) {
            alert("No users selected.");
            return;
        }

        try {
            const response = await fetch('/users/bulk-delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ emails: selectedEmails })
            });

            const result = await response.json();
            if (result.message) {
                alert(result.message);
                location.reload();
            } else {
                alert("Failed to delete users.");
            }
        } catch (error) {
            console.error(error);
            alert("An error occurred while deleting users.");
        }
    }

    async function bulkSuspend() {
        const selectedEmails = getSelectedEmails();
        if (selectedEmails.length === 0) {
            alert("No users selected.");
            return;
        }

        try {
            const response = await fetch('/users/bulk-suspend', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ emails: selectedEmails, action: "suspend" })
            });

            const result = await response.json();
            if (result.message) {
                alert(result.message);
                location.reload();
            } else {
                alert("Failed to suspend users.");
            }
        } catch (error) {
            console.error(error);
            alert("An error occurred while suspending users.");
        }
    }

    async function bulkResetPassword() {
        const selectedEmails = getSelectedEmails();
        if (selectedEmails.length === 0) {
            alert("No users selected.");
            return;
        }

        try {
            const response = await fetch('/users/bulk-reset-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ emails: selectedEmails })
            });

            const result = await response.json();
            if (result.message) {
                alert(result.message);
                location.reload();
            } else {
                alert("Failed to reset passwords.");
            }
        } catch (error) {
            console.error(error);
            alert("An error occurred while resetting passwords.");
        }
    }

    // Individual actions
    async function resetPassword(email) {
        if (!confirm(`Are you sure you want to reset the password for ${email}?`)) return;

        try {
            const response = await fetch('/users/reset-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            });

            const result = await response.json();
            alert(result.message || "Failed to reset password.");
        } catch (error) {
            console.error(error);
            alert("An error occurred while resetting the password.");
        }
    }

    async function renameUser(email) {
        const newName = prompt("Enter the new name for the user:");
        if (!newName) return;

        try {
            const response = await fetch('/users/rename', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, newName })
            });

            const result = await response.json();
            alert(result.message || "Failed to rename user.");
        } catch (error) {
            console.error(error);
            alert("An error occurred while renaming the user.");
        }
    }

    async function addToGroup(email) {
        const groupName = prompt("Enter the group name to add the user to:");
        if (!groupName) return;

        try {
            const response = await fetch('/users/add-to-group', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, groupName })
            });

            const result = await response.json();
            alert(result.message || "Failed to add user to group.");
        } catch (error) {
            console.error(error);
            alert("An error occurred while adding the user to the group.");
        }
    }

    function getSelectedEmails() {
        return Array.from(document.querySelectorAll(".user-checkbox:checked")).map(checkbox => checkbox.dataset.email);
    }
</script>
{% endblock %}
